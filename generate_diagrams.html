<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSmart 시스템 아키텍처 다이어그램</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .diagram {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .download-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .download-btn:hover {
            background: #005a9e;
        }
        .description {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 CSmart 시스템 아키텍처 다이어그램</h1>
        
        <div class="description">
            <strong>📋 사용법:</strong> 각 다이어그램을 클릭하여 확대하고, 우클릭으로 이미지를 저장할 수 있습니다.
        </div>

        <h2>1. 전체 시스템 구조</h2>
        <div class="diagram">
            <div class="mermaid" id="diagram1">
graph TD
    A[사용자 질문] --> B{질문 복잡도 판별}
    
    B -->|간단한 질문| C[파인튜닝 모델]
    B -->|복잡한 질문| D[LangGraph 에이전트]
    
    C --> C1[CSmart-FAQ API 호출]
    C1 --> C2[Gemma 2B 파인튜닝 모델]
    C2 --> C3[원시 답변 생성]
    C3 --> C4[LLM 재가공]
    C4 --> C5[재가공된 답변]
    C5 --> C6{답변 품질 평가}
    
    C6 -->|품질 양호 6점 이상| C7[재가공된 답변 반환]
    C6 -->|품질 미달 6점 미만| C8[LangGraph로 재라우팅]
    
    C8 --> D
    D --> D1[통합 에이전트]
    D1 --> D2{데이터 소스 선택}
    
    D2 -->|GuidelineDB| E[가이드라인 에이전트]
    D2 -->|Web Search| F[웹 검색 에이전트]
    
    E --> E1[하이브리드 검색]
    E1 --> E2[키워드 매칭]
    E1 --> E3[벡터 유사도]
    E2 --> E4[Chroma DB]
    E3 --> E4
    E4 --> E5[문서 검색]
    E5 --> E6[답변 생성]
    
    F --> F1[Tavily API]
    F1 --> F2[웹 검색]
    F2 --> F3[검색 결과]
    F3 --> F4[답변 생성]
    
    E6 --> G[최종 답변]
    F4 --> G
    C5 --> G
    
    G --> H[사용자에게 응답]
    
    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#e8f5e8
    style C4 fill:#fff3e0
    style C6 fill:#ffebee
    style D fill:#f3e5f5
    style G fill:#fff9c4
    style H fill:#e1f5fe
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram1', '전체시스템구조')">이미지 다운로드</button>
        </div>

        <h2>2. 라우팅 로직 상세</h2>
        <div class="diagram">
            <div class="mermaid" id="diagram2">
flowchart TD
    A[질문 입력] --> B{수동선택 여부}
    B -->|Yes| B1{어떤 모델?}
    B1 -->|파인튜닝 모델| C[파인튜닝 모델 호출]
    B1 -->|LangGraph 에이전트| D[LangGraph 에이전트 호출]
    
    B -->|No| E[질문 복잡도 판별]
    E --> F{질문 분석}
    F -->|일반적인 학습 조언| G[Simple 분류]
    F -->|특정 대학/일정 정보| H[Complex 분류]
    
    G --> C
    H --> D
    
    C --> C1[파인튜닝 모델 원시 답변]
    C1 --> C2[LLM 재가공]
    C2 --> C3[재가공된 답변]
    C3 --> C4{답변 품질 평가}
    C4 -->|6점 이상| C5[재가공된 답변 반환]
    C4 -->|6점 미만| C6[LangGraph로 재라우팅]
    C6 --> D
    
    D --> J[검색 기반 답변 생성]
    
    C5 --> K[최종 답변]
    J --> K
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram2', '라우팅로직')">이미지 다운로드</button>
        </div>

        <h2>3. 데이터 흐름도</h2>
        <div class="diagram">
            <div class="mermaid" id="diagram3">
sequenceDiagram
    participant U as 사용자
    participant API as API Layer
    participant R as Router
    participant F as 파인튜닝 모델
    participant RF as 답변 재가공
    participant E as 답변 품질 평가
    participant L as LangGraph
    participant DB as Chroma DB
    participant W as Web Search
    
    U->>API: 질문 입력
    API->>R: 질문 복잡도 판별
    R->>R: LLM으로 분석
    
    alt 간단한 질문
        R->>F: CSmart-FAQ API 호출
        F->>F: Gemma 2B 모델 처리
        F->>R: 원시 답변 반환
        R->>RF: 답변 재가공 요청
        RF->>RF: LLM으로 답변 개선
        RF->>R: 재가공된 답변 반환
        R->>E: 답변 품질 평가 요청
        E->>E: LLM으로 품질 분석 (1-10점)
        
        alt 품질 양호 (6점 이상)
            E->>R: 품질 양호 판정
            R->>API: 재가공된 답변 전달
        else 품질 미달 (6점 미만)
            E->>R: 품질 미달 판정
            R->>L: LangGraph로 재라우팅
            L->>DB: 하이브리드 검색
            L->>W: 웹 검색 (필요시)
            DB->>L: 관련 문서 반환
            W->>L: 웹 검색 결과
            L->>L: 답변 생성
            L->>R: 생성된 답변
            R->>API: LangGraph 답변 전달
        end
    else 복잡한 질문
        R->>L: LangGraph 에이전트 실행
        L->>DB: 하이브리드 검색
        L->>W: 웹 검색 (필요시)
        DB->>L: 관련 문서 반환
        W->>L: 웹 검색 결과
        L->>L: 답변 생성
        L->>R: 생성된 답변
        R->>API: 답변 전달
    end
    
    API->>U: 최종 답변 반환
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram3', '데이터흐름도')">이미지 다운로드</button>
        </div>

        <h2>4. 컴포넌트별 상세 구조</h2>
        <div class="diagram">
            <div class="mermaid" id="diagram4">
graph LR
    subgraph "API Layer"
        A1[get_answer 함수]
        A2[질문 복잡도 판별]
        A3[파인튜닝 모델 호출]
        A4[답변 재가공]
        A5[답변 품질 평가]
    end
    
    subgraph "파인튜닝 모델"
        F1[CSmart-FAQ API]
        F2[Gemma 2B 모델]
        F3[답변 생성]
    end
    
    subgraph "LangGraph 시스템"
        L1[통합 에이전트]
        L2[가이드라인 에이전트]
        L3[웹 검색 에이전트]
    end
    
    subgraph "데이터 소스"
        D1[Chroma DB]
        D2[Tavily API]
        D3[Google Gemini]
    end
    
    A1 --> A2
    A1 --> A3
    A1 --> A4
    A1 --> A5
    A2 --> L1
    A3 --> F1
    A4 --> A5
    A5 --> L1
    F1 --> F2
    F2 --> F3
    L1 --> L2
    L1 --> L3
    L2 --> D1
    L3 --> D2
    D1 --> D3
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram4', '컴포넌트구조')">이미지 다운로드</button>
        </div>

        <h2>5. 답변 처리 방식 비교</h2>
        <div class="diagram">
            <div class="mermaid" id="diagram5">
graph TD
    A[질문 입력] --> B{질문 유형}
    
    B -->|간단한 질문| C[파인튜닝 모델]
    B -->|복잡한 질문| D[LangGraph 에이전트]
    
    C --> C1[API 호출]
    C1 --> C2[모델 처리]
    C2 --> C3[원시 답변 생성]
    C3 --> C4[LLM 재가공]
    C4 --> C5[재가공된 답변]
    C5 --> C6{답변 품질 평가}
    C6 -->|6점 이상| C7[재가공된 답변 반환]
    C6 -->|6점 미만| C8[LangGraph로 재라우팅]
    C8 --> D
    
    D --> D1[데이터 검색]
    D1 --> D2[문서 분석]
    D2 --> D3[답변 생성]
    D3 --> D4[검색 기반 답변]
    
    C7 --> E[최종 답변]
    D4 --> E
    
    style C4 fill:#fff3e0
    style C6 fill:#ffebee
    style D4 fill:#e8f5e8
            </div>
            <button class="download-btn" onclick="downloadDiagram('diagram5', '답변처리방식')">이미지 다운로드</button>
        </div>

        <div class="description">
            <strong>💡 팁:</strong> 
            <ul>
                <li>각 다이어그램을 클릭하면 확대/축소할 수 있습니다.</li>
                <li>우클릭 → "이미지로 저장"을 선택하여 다이어그램을 저장할 수 있습니다.</li>
                <li>다운로드 버튼을 클릭하면 고해상도 이미지로 저장됩니다.</li>
            </ul>
        </div>
    </div>

    <script>
        // Mermaid 초기화
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true
            }
        });

        // 다이어그램 다운로드 함수
        function downloadDiagram(diagramId, filename) {
            const element = document.getElementById(diagramId);
            const svg = element.querySelector('svg');
            
            if (svg) {
                // SVG를 Canvas로 변환
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // SVG 크기 가져오기
                const svgRect = svg.getBoundingClientRect();
                canvas.width = svgRect.width * 2; // 고해상도
                canvas.height = svgRect.height * 2;
                
                // SVG를 이미지로 변환
                const svgData = new XMLSerializer().serializeToString(svg);
                const img = new Image();
                
                img.onload = function() {
                    ctx.scale(2, 2); // 고해상도
                    ctx.drawImage(img, 0, 0);
                    
                    // PNG로 다운로드
                    canvas.toBlob(function(blob) {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `CSmart_${filename}_${new Date().toISOString().slice(0,10)}.png`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    });
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            }
        }

        // 페이지 로드 완료 후 다이어그램 렌더링
        window.addEventListener('load', function() {
            mermaid.init();
        });
    </script>
</body>
</html>
